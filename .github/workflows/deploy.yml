name: Docker Image CI

on:
    push:
        branches:
            - "deploy"
            # - "test-deploy"
            # tags:
            #   - "v*"
            #   - "t*"

jobs:
    build:
        # if: ${{ startsWith(github.ref, 'refs/tags/t') || startsWith(github.ref, 'refs/heads/test-deploy/') || startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/heads/deploy/') }}
        runs-on: ubuntu-latest

        steps:
            # 拉取main分支代码
            - name: Checkout
              uses: actions/checkout@v2
              uses: actions/setup-node@v2
              with:
                node-version: 16.13

            # 打包
            - name: build
              run: yarn install
              run: yarn build
              run: tar -zcvf dist.tgz .out

             - name: Create Release
               id: create_release
               uses: actions/create-release@master
               env:
                 GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
               with:
                 tag_name: ${{ github.ref }}
                 release_name: Release ${{ github.ref }}
                 draft: false
                 prerelease: false

            - name: Upload Release Asset
              id: upload-release-asset
              uses: actions/upload-release-asset@master
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                upload_url: ${{ steps.create_release.outputs.upload_url }}
                asset_path: ./out.tgz
                asset_name: out.tgz
                asset_content_type: application/x-tgz
              

            - name: Upload dist ssh
              uses: easingthemes/ssh-deploy@v2.1.6
              with:
                REMOTE_USER: 'root'
                REMOTE_HOST: '${{ secrets.ONLINE_HOST }}' #测试服务器地址
                SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_PRIV_KEY }}
                TARGET: '/root/yaklang-community/' #服务器中，代码部署的位置

          - name: Deploy
            # if: ${{ startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/heads/main/') }}
            uses: appleboy/ssh-action@master # 使用ssh链接服务器
            with:
            host: ${{ secrets.ONLINE_HOST }}
            username: 'root'
            key: ${{ secrets.DEPLOY_PRIV_KEY }}
            script: |
              cd /root/yakit-community/
              tar zxvf out.tgz
